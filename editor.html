<html>

<head>
    <title>Patrick's Hyperbox editor</title>
    <meta charset="UTF-8">
    <style>
        div {
            margin-bottom: 5px;
        }

        .selected {
            font-weight: bold;
        }

        .group {
            margin-right: 10px;
        }

        canvas {
            width: 1200px;
            height: 800px;
            border: 1px solid black;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <div id="menu">
        <input id="load" type="file" style="display:none;" />
        <input type="button" value="Load" onclick="document.getElementById('load').click();" />

        <a id="download" download="hyperbox.txt" style="display:none;"></a>
        <input type="button" value="Save" onclick="download();" />
    </div>
    <hr>
    <div>
        <span id="block-select"></span>
        <input type="button" value="Add new block" onclick="createNewBlock();" />
    </div>
    <div id="block-info"></div>
    <hr>
    <div>
        <span>Select item to add: </span>
        <span id="item-select"></span>
    </div>
    <canvas id="canvas"></canvas>

    <script src="./tessellations.js"></script>
    <script src="./map.js"></script>
    <script src="./rendering.js"></script>
    <script src="./serialization.js"></script>
    <script>
        const P = 4;
        let gameMap = newGameMap(P);
        let selectedBlock = 0;
        let selectableItems = [];
        let selectedItem = 0;
        let polygons = undefined;

        const canvas = document.getElementById('canvas');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;

        document.getElementById('load').addEventListener('change', e => {
            const reader = new FileReader();
            reader.onload = function() {
                // TODO deserialize into game map
                console.log(reader.result);
                updateHtml();
            };
            reader.readAsText(e.target.files[0]);
        });

        function download() {
            const downloadLink = document.getElementById('download');
            downloadLink.href = window.URL.createObjectURL(new Blob([serialize(gameMap)], { type: 'text/plain' }));
            downloadLink.click();
        }

        function createNewBlock() {
            addBlockToGameMap(gameMap, {});
            selectedBlock = gameMap.blocks.length - 1;
            updateHtml();
        }

        canvas.addEventListener('mousedown', e => {
            const { left, top } = canvas.getBoundingClientRect();
            const x = e.clientX - left, y = e.clientY - top;
            const coordinate = findContainingNode(polygons, x, y);
            if (coordinate !== undefined) {
                const { blockIndex, nodeIndex } = coordinate;
                const [ label, type, childBlock ] = selectableItems[selectedItem];
                updateContents(gameMap, blockIndex, nodeIndex, type, childBlock);
                updateHtml();
            }
        });

        function updateBlockSelect() {
            let innerHTML = '';
            for (let i = 0; i < gameMap.blocks.length; i++) {
                const style = i === selectedBlock ? 'class="selected"' : '';
                innerHTML += `<input type="button" ${style} value="Block ${i + 1}" onclick="selectedBlock = ${i}; updateHtml();" />`;
            }
            document.getElementById('block-select').innerHTML = innerHTML;
        }

        function updateBlock(newProperties) {
            updateBlockInGameMap(gameMap, gameMap.blocks[selectedBlock], newProperties);
        }

        function updateBlockInfo() {
            let innerHTML = '';
            if (selectedBlock < gameMap.blocks.length) {
                const block = gameMap.blocks[selectedBlock];
                innerHTML = `
<span class="group">
    Squares per vertex: <input type="number" min="5" max="7" value="${block.q}"
    onchange="updateBlock({max_r: parseInt(value)}); updateHtml();" />
</span>
<span class="group">
    Max distance: <input type="number" min="1.0" max="6.0" value="${block.max_r}"
    onchange="updateBlock({max_r: parseFloat(value)}); updateHtml();" />
</span>
<span class="group">
    Min steps to exit: <input type="number" min="0" max="5" value="${block.minRadius}"
    onchange="updateBlock({minRadius: parseInt(value)}); updateHtml();" />
</span>
<span class="group">
    Hue: <input type="number" min="0" max="359" value="${block.hue}"
    onchange="updateBlock({hue: parseInt(value)}); updateHtml();" />
</span>
<span class="group">
    Sat: <input type="number" min="0" max="1.00" value="${block.sat}"
    onchange="updateBlock({hue: parseFloat(value)}); updateHtml();" />
</span>
<span class="group">
    Val: <input type="number" min="0" max="1.00" value="${block.val}"
    onchange="updateBlock({hue: parseFloat(value)}); updateHtml();" />
</span>
<span class="group">
    Is player: <input type="button" value="${block.player ? 'Yes' : 'No'}"
    onclick="updateBlock({player: value === 'No'}); updateHtml();"/>
</span>
<input type="button" value="Delete block" onclick="TODO; updateHtml();" />
                `;
            }
            document.getElementById('block-info').innerHTML = innerHTML;
        }

        function updateItemSelect() {
            selectableItems = [
                ['Empty space', 'Empty', undefined],
                ['Wall', 'Wall', undefined],
                ['Button', 'Button', undefined],
                ['Player button', 'PlayerButton', undefined],
            ];
            for (let i = 0; i < gameMap.blocks.length; i++) {
                selectableItems.push([`Block ${i+1}`, 'Ref', gameMap.blocks[i]]);
            }
            let innerHTML = '';
            for (let i = 0; i < selectableItems.length; i++) {
                const [ label, type, childBlock ] = selectableItems[i];
                const style = i === selectedItem ? 'class="selected"' : '';
                innerHTML += `<input type="button" ${style} value="${label}" onclick="selectedItem = ${i}; updateHtml();" />`;
            }
            document.getElementById('item-select').innerHTML = innerHTML;
        }

        function updateHtml() {
            updateBlockSelect();
            updateBlockInfo();
            updateItemSelect();

            // TODO temporarily render the block as if it's in space
            const space = addBlockToGameMap(gameMap, { q: 5, max_r: 1, minRadius: 0, hue: 0, sat: 0, val: 0 });
            updateContents(gameMap, gameMap.blocks.length - 1, 0, 'Ref', gameMap.blocks[selectedBlock]);
            polygons = getPolygons(gameMap, new Map(), 0, undefined, selectedBlock);
            render(canvas, polygons);
            gameMap.blocks.pop();
            gameMap.refs.pop();
        }

        updateHtml();
    </script>
</body>

</html>
