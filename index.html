<html>

<head>
    <style>
        canvas {
            width: 1200px;
            height: 800px;
            border: 1px solid black;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <script src="./tessellations.js"></script>
    <script src="./map.js"></script>
    <script src="./rendering.js"></script>
    <script>
        // ‚Åª

        const P = 4, Q = 5;
        const gameMap = newGameMap(P);
        const outerRoom = addBlockToGameMap(gameMap, undefined, undefined, Q, [2, 2], [120, 1, .5], false, false);
        const middleRoom = addBlockToGameMap(gameMap, outerRoom, [], Q, [3, 2], [197, .71, .5], false, false);
        const innerRoom = addBlockToGameMap(gameMap, middleRoom, [0, 1], Q, [3, 1], [39, 1, .5], false, false);
        const player = addBlockToGameMap(gameMap, middleRoom, [3], Q, [1, 0], [350, 1, .75], true, true);
        const normalBlock = addBlockToGameMap(gameMap, middleRoom, [0], Q, [1, 0], [0, .59, .4], true, false);
        addButtonToGameMap(gameMap, innerRoom, [2]);
        for (let nodeIndex = 10; nodeIndex <= 44; nodeIndex++) {
            if (![22, 31, 37, 40].includes(nodeIndex)) {
                middleRoom.nodes[nodeIndex].contents = { type: 'Wall' };
            }
        }
        gameMap.blocks[player.parentNode.blockIndex].nodes[player.parentNode.nodeIndex].facingNeighborIndex = 3;
        gameMap.playerButton = { blockIndex: 0, nodeIndex: 7 };

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;

        const contentsLocationMap = new Map();
        let animatingStep = 0;
        let currDir = undefined;
        render(ctx, gameMap, contentsLocationMap, animatingStep);

        function animate() {
            if (animatingStep > 0) {
                animatingStep--;
                setTimeout(animate, 40);
                render(ctx, gameMap, contentsLocationMap, animatingStep, currDir);
            } else if (isWin(gameMap)) {
                alert('You win!');
            }
        }
        document.addEventListener('keydown', e => {
            const dir = { ArrowRight: 0, ArrowUp: 1, ArrowLeft: 2, ArrowDown: 3 }[e.code];
            if (dir === undefined || animatingStep !== 0) {
                return;
            }
            movePlayer(gameMap, dir);
            animatingStep = NUM_ANIMATION_STEPS;
            currDir = dir;
            animate();
            e.preventDefault();
        });
    </script>
</body>

</html>
