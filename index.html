<html>

<head>
    <title>Patrick's Hyperbox</title>
    <meta charset="UTF-8">
    <meta name="Description" content="Patrick's Parabox in hyperbolic space">
    <style>
        div {
            width: 1200px;
            height: 800px;
            border: 1px solid black;
            margin: 0 auto;
            position: relative;
        }

        .key {
            position: absolute;
            font-size: 60px;
            width: 80px;
            height: 80px;
        }
    </style>
</head>

<body>
    <div>
        <canvas id="canvas"></canvas>
        <input type="button" class="key" style="bottom: 10px; right: 10px;" value="→" onclick="moveDir(0);" />
        <input type="button" class="key" style="bottom: 100px; right: 100px;" value="↑" onclick="moveDir(1);" />
        <input type="button" class="key" style="bottom: 10px; right: 190px;" value="←" onclick="moveDir(2);" />
        <input type="button" class="key" style="bottom: 10px; right: 100px;" value="↓" onclick="moveDir(3);" />
    </div>
    <script src="./tessellations.js"></script>
    <script src="./map.js"></script>
    <script src="./rendering.js"></script>
    <script>

        const P = 4, Q = 5;
        const gameMap = newGameMap(P);
        const outerRoom = addBlockToGameMap(gameMap, { q: Q, max_r: 2, minRadius: 2, hue: 120, sat: 1, val: .5 });
        const middleRoom = addBlockToGameMap(gameMap, { q: Q, max_r: 3, minRadius: 2, hue: 197, sat: .71, val: .5 });
        const innerRoom = addBlockToGameMap(gameMap, { q: Q, max_r: 3, minRadius: 1, hue: 39, sat: 1, val: .5 });
        const player = addBlockToGameMap(
            gameMap, { q: Q, max_r: 1, minRadius: 0, hue: 350, sat: 1, val: .75, fillWithWalls: true, player: true });
        const normalBlock = addBlockToGameMap(
            gameMap, { q: Q, max_r: 1, minRadius: 0, hue: 0, sat: .59, val: .4, fillWithWalls: true });
        const niceUpdateContents = (gameMap, block, path, type, childBlock) => updateContents(
            gameMap, gameMap.blocks.findIndex(b => b === block), getNodeIndex(block, path), type, gameMap.blocks.findIndex(b => b === childBlock));
        niceUpdateContents(gameMap, outerRoom, [], 'Ref', middleRoom);
        niceUpdateContents(gameMap, middleRoom, [0, 1], 'Ref', innerRoom);
        niceUpdateContents(gameMap, middleRoom, [3], 'Ref', player);
        niceUpdateContents(gameMap, middleRoom, [0], 'Ref', normalBlock);
        niceUpdateContents(gameMap, innerRoom, [2], 'Button');
        niceUpdateContents(gameMap, outerRoom, [1], 'PlayerButton');
        const wallPaths = [
            [0, 1, 2], [0, 1, 2, 1], [0, 1, 2, 1, 0], [0, 2], [0, 2, 1], [0, 2, 1, 1], [0, 2, 3],
            [0, 2, 3, 3], [2, 3, 2], [2, 3, 2, 3], [2, 3, 2, 3, 3], [2, 2], [2, 2, 3], [2, 2, 3, 3],
            [2, 2, 1], [2, 2, 1, 1], [1, 2], [1, 2, 1], [1, 2, 1, 1], [1, 2, 3], [1, 2, 3, 3],
            [1, 1, 2], [1, 1, 2, 1], [1, 1, 2, 1, 0], [1, 3, 2], [1, 3, 2, 3], [1, 3, 2, 3, 3],
            [3, 2, 1], [3, 2, 1, 1], [3, 2, 3], [3, 2, 3, 3],
        ];
        for (const path of wallPaths) {
            niceUpdateContents(gameMap, middleRoom, path, 'Wall');
        }
        getNode(middleRoom, [3]).facingNeighborIndex = 3;

        const canvas = document.getElementById('canvas');
        canvas.width = WIDTH;
        canvas.height = HEIGHT;

        const contentsLocationMap = new Map();
        let animatingStep = 0;
        let currDir = undefined;
        render(canvas, getPolygons(gameMap, contentsLocationMap, animatingStep));

        function animate() {
            if (animatingStep > 0) {
                animatingStep--;
                setTimeout(animate, 40);
                render(canvas, getPolygons(gameMap, contentsLocationMap, animatingStep, currDir));
            } else if (isWin(gameMap)) {
                alert('You win!');
            }
        }

        function moveDir(dir) {
            if (animatingStep !== 0) {
                return;
            }
            movePlayer(gameMap, dir);
            animatingStep = NUM_ANIMATION_STEPS;
            currDir = dir;
            animate();
        }

        document.addEventListener('keydown', e => {
            const dir = { ArrowRight: 0, ArrowUp: 1, ArrowLeft: 2, ArrowDown: 3 }[e.code];
            if (dir !== undefined) {
                moveDir(dir);
                e.preventDefault();
            }
        });
    </script>
</body>

</html>
